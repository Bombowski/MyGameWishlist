<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN'
  'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>
  
<mapper namespace="mygamewishlist.model.dao.mapper.ReviewMapper">

	<select id="getReviews" resultMap="reviewListMap">
		SELECT
			AVG(RE.RATING) AS AVERAGE_RATING, USER_RATING, GA.ID AS ID_GAME, GA.NAME AS NAME
		FROM
			GAME GA, REVIEW RE, USER US,
		    (
				SELECT
					GA.ID AS IDG, RATING AS USER_RATING
				FROM
					GAME GA LEFT JOIN REVIEW RE ON GA.ID = RE.ID_GAME AND RE.ID_USER = 1
		        ORDER BY
					GA.ID
		    ) SUB
		WHERE
			GA.ID = RE.ID_GAME AND
		    RE.ID_USER = US.ID AND
		    IDG = RE.ID_GAME
		GROUP BY
			GA.NAME, USER_RATING, GA.ID
		ORDER BY
			GA.ID
	</select>
	
	<update id="updateReview" parameterType="Review">
		UPDATE REVIEW SET RATING = #{rating} WHERE ID_USER = #{idUser} AND ID_GAME = #{idGame}
	</update>
	
	<delete id="deleteReview" parameterType="Review">
		DELETE REVIEW WHERE ID_USER = #{idUser} AND ID_GAME = #{idGame}
	</delete>
	
	<resultMap type="Review" id="reviewMap">
		<id property="idUser" column="ID_USER"/>
		<id property="idGame" column="ID_GAME"/>
		<result property="rating" column="RATING"/>
	</resultMap>
	
	<resultMap type="ReviewList" id="reviewListMap">
		<result property="averageRating" column="AVERAGE_RATING"/>
		<result property="userRating" column="USER_RATING"/>
		<result property="name" column="NAME"/>
		<result property="idGame" column="ID_GAME"/>
	</resultMap>
</mapper>