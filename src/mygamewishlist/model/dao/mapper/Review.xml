<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN'
  'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>
  
<mapper namespace="mygamewishlist.model.dao.mapper.ReviewMapper">

	<select id="getReviewList" resultMap="reviewListMap">
		SELECT
			IFNULL(AVG(RE.RATING),-1) AS AVERAGE_RATING, 
            IFNULL(SUB.USER_RATING, -1),
			GA.ID AS ID_GAME, GA.NAME AS NAME, RE.REVIEW,
		    GROUP_CONCAT(GE.NAME SEPARATOR ', ') AS GENRES
		FROM
			REVIEW RE RIGHT JOIN GAME GA ON RE.ID_GAME = GA.ID,
			(SELECT
					GA2.ID AS IDG, RE2.RATING AS USER_RATING
				FROM
					GAME GA2 LEFT JOIN REVIEW RE2 ON GA2.ID = RE2.ID_GAME AND RE2.ID_USER = 1
				ORDER BY
					GA2.ID
			) SUB, GENRE GE, GAME_GENRE GG
		WHERE
			IDG = GA.ID AND
		    GE.ID = GG.ID_GENRE AND
		    GA.ID = GG.ID_GAME
		GROUP BY
			GA.NAME, GA.ID, IDG, RE.REVIEW
		ORDER BY 
			GA.ID
	</select>
	
	<select id="getReviewListNotLogged" resultMap="reviewListMap">
		SELECT
			IFNULL(AVG(RE.RATING), -1) AS AVERAGE_RATING, -1 AS USER_RATING, GA.ID AS ID_GAME, 
			GA.NAME AS NAME, GROUP_CONCAT(GE.NAME SEPARATOR ', ') AS GENRES
		FROM
			GAME GA LEFT JOIN REVIEW RE ON GA.ID = RE.ID_GAME,
		    GENRE GE, GAME_GENRE GG
		WHERE
			GG.ID_GENRE = GE.ID AND
		    GG.ID_GAME = GA.ID
		GROUP BY
			GA.NAME, USER_RATING, GA.ID
		ORDER BY
			GA.ID
	</select>
	
	<update id="addOrUpdateReview" parameterType="Review">
		INSERT INTO REVIEW (ID_USER, ID_GAME, RATING) VALUES
			(#{idUser},#{idGame},#{rating}) ON DUPLICATE KEY UPDATE
			RATING = #{rating}
	</update>
	
	<delete id="deleteReview" parameterType="Review">
		DELETE REVIEW WHERE ID_USER = #{idUser} AND ID_GAME = #{idGame}
	</delete>
	
	<resultMap type="Review" id="reviewMap">
		<id property="idUser" column="ID_USER"/>
		<id property="idGame" column="ID_GAME"/>
		<result property="rating" column="RATING"/>
	</resultMap>
	
	<resultMap type="ReviewList" id="reviewListMap">
		<result property="averageRating" column="AVERAGE_RATING"/>
		<result property="userRating" column="USER_RATING"/>
		<result property="name" column="NAME"/>
		<result property="idGame" column="ID_GAME"/>
		<result property="genres" column="GENRES" />
	</resultMap>
</mapper>