<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC '-//mybatis.org//DTD Mapper 3.0//EN'
  'http://mybatis.org/dtd/mybatis-3-mapper.dtd'>
  
<mapper namespace="mygamewishlist.model.dao.mapper.WishListGameMapper">
	
	<select id="getListByIdUser" resultMap="resultList">
		SELECT
			SH.URL AS STORE_URL, WG.URL AS GAME_URL, ID_LIST, ID_STORE, 
			WG.NAME, WG.IMG, DEFAULT_PRICE, CURRENT_PRICE, 
			(100 - (CURRENT_PRICE * 100 / DEFAULT_PRICE)) AS DISCOUNT,
			LAST_NOTIFIED_PRICE, MIN_PRICE, MAX_PRICE
		FROM
			WISHLIST_GAME WG, LIST LI, STORE SH
		WHERE
			LI.ID = WG.ID_LIST AND
			SH.ID = WG.ID_STORE AND
			LI.ID_USER = #{idUser}
	</select>
	
	<select id="getGameFromListByIdUserUrl" resultMap="resultList">
		SELECT
			SH.URL AS STORE_URL, WG.URL AS GAME_URL, ID_LIST, ID_STORE, 
			WG.NAME, WG.IMG, DEFAULT_PRICE, CURRENT_PRICE, 
			(100 - (CURRENT_PRICE * 100 / DEFAULT_PRICE)) AS DISCOUNT,
			LAST_NOTIFIED_PRICE, MIN_PRICE, MAX_PRICE
		FROM
			WISHLIST_GAME WG, LIST LI, STORE SH
		WHERE
			LI.ID = WG.ID_LIST AND
			SH.ID = WG.ID_STORE AND
			LI.ID_USER = #{idUser} AND
		    WG.URL = #{url}
	</select>
	
	<insert id="addGame2Wishlist" parameterType="WishListGame">
		INSERT INTO WISHLIST_GAME (URL,ID_LIST,ID_STORE,IMG,NAME,DEFAULT_PRICE,
		CURRENT_PRICE,MAX_PRICE,MIN_PRICE)
		VALUES(#{urlGame},#{idList},#{idStore},#{img},#{name},
		#{defaultPrice},#{currentPrice},#{minPrice},#{maxPrice})
	</insert>
	
	<select id="getGamesFromListById" resultMap="games2Scrap">
		SELECT
			ST.URL AS STORE_URL, WG.URL AS GAME_URL, ST.NAME STORE_NAME, 
			WG.NAME GAME_NAME, WG.IMG, DEFAULT_PRICE, CURRENT_PRICE, MIN_PRICE, MAX_PRICE
		FROM
			WISHLIST_GAME WG, LIST LI, STORE ST
		WHERE
			LI.ID = WG.ID_LIST AND
			ST.ID = WG.ID_STORE AND
			LI.ID_USER = #{idUser}
		ORDER BY
			ST.NAME;
	</select>
	
	<delete id="deleteGameWishlist">
		DELETE FROM WISHLIST_GAME WHERE URL = #{url} AND ID_LIST = #{idList}
	</delete>
	
	<update id="updatePrices" parameterType="ScrapedGame">
		UPDATE WISHLIST_GAME SET DEFAULT_PRICE = #{defaultPrice}, CURRENT_PRICE = #{currentPrice}
		WHERE URL = #{url} AND ID_LIST = #{idList} 
	</update>
	
	<update id="updateMinMax">
		UPDATE WISHLIST_GAME SET MAX_PRICE = #{max}, MIN_PRICE = #{min}
		WHERE URL = #{url} AND ID_LIST = #{idList}
	</update>
	
	<resultMap type="WishListGame" id="resultList">
		<id property="urlGame" column="GAME_URL" />
		<id property="idList" column="ID_LIST" />
		<result property="urlStore" column="STORE_URL" />
		<result property="idStore" column="ID_STORE" />
		<result property="name" column="NAME" />
		<result property="img" column="IMG" />
		<result property="defaultPrice" column="DEFAULT_PRICE" />
		<result property="currentPrice" column="CURRENT_PRICE" />
		<result property="discount" column="DISCOUNT" />
		<result property="lastNotifiedPrice" column="LAST_NOTIFIED_PRICE" />
		<result property="minPrice" column="MIN_PRICE" />
		<result property="maxPrice" column="MAX_PRICE" />
	</resultMap>
	
	<resultMap type="WishListGame2Scrap" id="games2Scrap">
		<result property="storeUrl" column="STORE_URL" />
		<result property="gameUrl" column="GAME_URL" />
		<result property="storeName" column="STORE_NAME" />
		<result property="gameName" column="GAME_NAME" />
		<result property="img" column="IMG" />
		<result property="defaultPrice" column="DEFAULT_PRICE" />
		<result property="currentPrice" column="CURRENT_PRICE" />
		<result property="minPrice" column="MIN_PRICE" />
		<result property="maxPrice" column="MAX_PRICE" />
	</resultMap>
</mapper>